Date: 2025-08-31

Summary
- Extracted inbound command parsing from ConnectionReaderThread into a new, testable component to improve Single Responsibility Principle (SRP) and increase test coverage before refactor.

Key Changes
- Added: src/main/java/im/redpanda/core/InboundCommandProcessor.java
  - Owns parsing/handling for: PING, PONG, REQUEST_PEERLIST, SEND_PEERLIST, UPDATE_* (jar) commands, ANDROID_UPDATE_* commands, KADEMLIA_GET/KADEMLIA_GET_ANSWER, and FLASCHENPOST_PUT.
  - Uses existing ServerContext services and ByteBufferPool; reuses update locks from ConnectionReaderThread.

- Updated: src/main/java/im/redpanda/core/ConnectionReaderThread.java
  - Introduced field: InboundCommandProcessor inboundProcessor.
  - Delegates inbound parsing: loopCommands(...) and parseCommand(...) now forward to InboundCommandProcessor.
  - Changed visibility of updateUploadLock and updateDownloadLock to package-private (static) for reuse by the processor.
  - Kept helper methods readString(...) and parseString(...) because tests reference them.

Tests
- Added: src/test/java/im/redpanda/core/InboundCommandProcessorTest.java
  - Verifies: PING -> PONG; PONG updates metrics; KADEMLIA_GET_ANSWER consumption length.
- Updated: src/test/java/im/redpanda/core/ParseCommandTest.java
  - Now targets InboundCommandProcessor instead of ConnectionReaderThread for loopCommands/parseCommand.

Build/Run Status
- Unit tests: Passed in this workspace (mvn test).
- E2E: TwoNodesE2EIT passed under Failsafe profile.

Rationale
- ConnectionReaderThread previously mixed concerns: NIO read loop, crypto decrypt/encrypt, and full protocol parsing/side-effects. Extracting parsing isolates protocol logic for unit testing and future evolution.

Followâ€‘ups (optional)
- Move parseString/readString helpers to a small utility (e.g., ByteBufUtil) and update tests.
- Consider further splits: handshake helpers into a HandshakeIO/Negotiator.

Developer Notes
- No external API changes intended; hot path now routes through InboundCommandProcessor.
- updateUploadLock/updateDownloadLock remain in ConnectionReaderThread (package-private) to preserve existing concurrency behavior across components.

